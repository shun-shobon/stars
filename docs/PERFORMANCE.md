# パフォーマンス最適化

このドキュメントでは、モバイルデバイスやSafariでのクラッシュを防ぐために実装されたパフォーマンス最適化について説明します。

## 問題の背景

WebサイトがSafariやモバイルデバイスから閲覧すると落ちてしまう問題がありました。主な原因は以下の通りです：

1. **過剰な星の描画**: 117,955個の星を毎フレーム描画（約70万頂点）
2. **高負荷なブルーム効果**: 5イテレーション × 2パス = 10ブラーパス
3. **高コストなガウシアンブラー**: 9-tap（9回のテクスチャサンプリング）
4. **高精度テクスチャ**: rgba16float形式を使用
5. **複雑なシェーダー**: 三角関数計算が多い

## 実装された最適化

### 1. デバイス検出システム

デバイスタイプを自動検出し、適切なパフォーマンスプロファイルを適用します。

**検出方法:**

- User Agentパターンマッチング
- 画面サイズベースの補完チェック

**デバイスタイプ:**

- `mobile`: スマートフォン（画面幅 < 768px）
- `tablet`: タブレット（768px ≤ 画面幅 < 1024px）
- `desktop`: デスクトップ（画面幅 ≥ 1024px）

### 2. パフォーマンスプロファイル

各デバイスタイプに最適化されたレンダリング設定を適用します。

#### モバイルプロファイル

```typescript
{
  maxStars: 30_000,           // 全体の約1/4に削減
  bloomIterations: 2,         // 5 → 2に削減（80%軽量化）
  bloomDownscale: 4,          // 1/2 → 1/4に変更（メモリ使用量1/4）
  blurTaps: 5,               // 9 → 5に削減（44%軽量化）
  textureFormat: "rgba8unorm", // メモリ帯域を半減
  maxMagnitude: 6.5,         // 肉眼の限界まで
}
```

**効果:**

- 頂点処理: 約75%削減
- ブルーム処理: 約92%軽量化（イテレーション数 × テクスチャサイズ × タップ数）
- メモリ使用量: 約87%削減
- メモリ帯域: 約50%削減

#### タブレットプロファイル

```typescript
{
  maxStars: 60_000,           // 全体の約1/2
  bloomIterations: 3,         // 5 → 3に削減
  bloomDownscale: 2,          // 1/2のまま
  blurTaps: 5,               // 9 → 5に削減
  textureFormat: "rgba16float", // 品質を保持
  maxMagnitude: 8,           // より暗い星まで表示
}
```

**効果:**

- 頂点処理: 約50%削減
- ブルーム処理: 約67%軽量化
- 高品質な描画を維持

#### デスクトッププロファイル

```typescript
{
  maxStars: 117_955,          // 全て表示
  bloomIterations: 3,         // 5 → 3に削減（デスクトップでも軽量化）
  bloomDownscale: 2,          // 1/2のまま
  blurTaps: 9,               // 9のまま（高品質）
  textureFormat: "rgba16float", // 高品質
  maxMagnitude: 14,          // 全ての星を表示
}
```

**効果:**

- ブルーム処理: 約40%軽量化
- 最高品質を維持しつつパフォーマンス向上

### 3. シェーダー最適化

#### 5-tap ガウシアンブラー（モバイル向け）

```wgsl
// テクスチャサンプリング回数: 5回（中心1回 + 周辺4回）
// 重み配列: [0.38774, 0.24477, 0.06136]
```

#### 9-tap ガウシアンブラー（デスクトップ向け）

```wgsl
// テクスチャサンプリング回数: 9回（中心1回 + 周辺8回）
// 重み配列: [0.227027, 0.1945946, 0.1216216, 0.054054, 0.016216]
```

### 4. 動的リソース管理

- **テクスチャフォーマット**: デバイスに応じて`rgba8unorm`または`rgba16float`を選択
- **ブルーム解像度**: デバイスに応じて1/2または1/4にダウンスケール
- **星の数**: パフォーマンスプロファイルに基づいて制限
- **等級フィルタリング**: 暗すぎる星をシェーダーレベルで除外

## パフォーマンス改善の測定

### 推定メモリ使用量（1920x1080解像度の場合）

#### 変更前（デスクトップ設定）

```
シーンテクスチャ: 1920 × 1080 × 8 bytes (rgba16float) = 16.6 MB
ブルームテクスチャ: 960 × 540 × 8 bytes × 2 = 8.3 MB
合計: 約24.9 MB

ブルーム処理: 10パス × 9サンプル = 90テクスチャフェッチ/ピクセル
星描画: 117,955インスタンス × 6頂点 = 707,730頂点
```

#### 変更後（モバイル設定）

```
シーンテクスチャ: 1920 × 1080 × 4 bytes (rgba8unorm) = 8.3 MB
ブルームテクスチャ: 480 × 270 × 4 bytes × 2 = 1.0 MB
合計: 約9.3 MB（62%削減）

ブルーム処理: 4パス × 5サンプル = 20テクスチャフェッチ/ピクセル（78%削減）
星描画: 30,000インスタンス × 6頂点 = 180,000頂点（75%削減）
```

## カスタマイズ

パフォーマンスプロファイルは必要に応じてカスタマイズ可能です：

```typescript
import { StarfieldRenderer } from "~/lib/webgpu/starfield";

// カスタムプロファイルで初期化
const customProfile = {
	maxStars: 50_000,
	bloomIterations: 2,
	bloomDownscale: 3,
	blurTaps: 5,
	textureFormat: "rgba8unorm",
	maxMagnitude: 7,
};

const renderer = new StarfieldRenderer(customProfile);
```

## 今後の改善案

1. **FPSモニタリング**: リアルタイムでFPSを監視し、動的に品質を調整
2. **WebGPUの機能検出**: デバイスのWebGPU機能に基づいた最適化
3. **視錐台カリング**: 画面外の星をCPU側でフィルタリング
4. **LODシステム**: カメラからの距離に応じて星の詳細度を調整
5. **ワーカースレッド**: 星データの前処理を別スレッドで実行

## 互換性

- **WebGPU対応ブラウザ**: Chrome 113+, Edge 113+, Safari 18+
- **最小要件**: WebGPU API、requestAnimationFrame
- **推奨環境**:
  - モバイル: iOS 18+, Android Chrome 113+
  - デスクトップ: Chrome/Edge 113+, Safari 18+

## トラブルシューティング

### 症状: モバイルで依然としてクラッシュする

**対処法:**

1. デバイスのメモリ状態を確認
2. 他のタブ・アプリを閉じる
3. より低い設定でカスタムプロファイルを作成

### 症状: デスクトップでフレームレートが低い

**対処法:**

1. ブラウザのハードウェアアクセラレーションを確認
2. GPUドライバーを最新版に更新
3. より軽量なプロファイルに切り替え

## 参考資料

- [WebGPU Specification](https://www.w3.org/TR/webgpu/)
- [Gaussian Blur Optimization](https://www.rastergrid.com/blog/2010/09/efficient-gaussian-blur-with-linear-sampling/)
- [Mobile Graphics Performance Best Practices](https://developer.apple.com/documentation/metal/metal_sample_code_library/optimizing_performance_with_the_gpu_counters_instrument)
